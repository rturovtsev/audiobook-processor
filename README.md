# Audiobook Processor

Консольное приложение на Go для обработки и объединения MP3 файлов аудиокниг в формат M4B с автоматическим созданием оглавления.

## Возможности

- **Обработка MP3 файлов**: Автоматическое переименование и сортировка файлов
- **Обновление метатегов**: Корректировка ID3v2 тегов для совместимости с медиасерверами
- **Создание оглавления**: Автоматическая генерация глав с временными метками
- **Конвертация в M4B**: Объединение файлов в единый аудиокнижный формат
- **Совместимость с Plex**: Оптимизация метаданных для медиасерверов

## Требования

### Системные требования
- **Go 1.23.0** или новее
- **FFmpeg** с поддержкой AAC кодека
- **FFprobe** (входит в состав FFmpeg)

### Установка зависимостей

#### Windows
```bash
# Установка FFmpeg через Chocolatey
choco install ffmpeg

# Или скачать с https://ffmpeg.org/download.html
```

#### macOS
```bash
# Установка через Homebrew
brew install ffmpeg
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install ffmpeg
```

## Установка

### Сборка из исходного кода
```bash
git clone https://github.com/rturovtsev/audiobook-processor.git
cd audiobook-processor
go build -o audiobook-processor main.go
```

### Проверка установки
```bash
./audiobook-processor --help
ffmpeg -version
ffprobe -version
```

## Использование

### Базовое использование
```bash
./audiobook-processor --input /path/to/mp3/files
```

### Полная команда с метаданными
```bash
./audiobook-processor \
  --input "/path/to/audiobook/files" \
  --author "Александр Пушкин" \
  --title "Евгений Онегин"
```

### Параметры командной строки

| Параметр | Описание | Обязательный |
|----------|----------|--------------|
| `--input` | Путь к папке с MP3 файлами | Да |
| `--author` | Автор книги | Нет |
| `--title` | Название книги | Нет |

## Как работает программа

### 1. Анализ и переименование файлов
- Сканирует указанную папку на наличие MP3 файлов
- Извлекает номера из названий файлов (например, `001_глава1.mp3`)
- Переименовывает файлы в стандартный формат: `001.mp3`, `002.mp3`, etc.
- Сортирует файлы по номерам для сохранения правильного порядка

### 2. Обработка метатегов
Для каждого MP3 файла:
- **Очищает** метатег "Исполнитель альбома" (TPE2)
- **Устанавливает** номер трека в формате "текущий/общий" (например, "1/15")
- **Устанавливает** номер диска на "1"
- **Удаляет** комментарии и заметки
- **Добавляет** автора и название книги (если указаны)

### 3. Создание оглавления
- Использует **ffprobe** для определения длительности каждого файла
- Извлекает названия глав из ID3 тегов (TIT2) или имен файлов
- Генерирует временные метки для каждой главы
- Создает файл метаданных в формате FFMETADATA

### 4. Объединение в M4B
- Использует **ffmpeg** для объединения всех MP3 файлов
- Конвертирует аудио в AAC формат (44.1 kHz, 128 kbps)
- Встраивает оглавление в результирующий M4B файл
- Сохраняет все метаданные

## Структура входных файлов

### Рекомендуемое именование
```
001_Пролог.mp3
002_Глава первая.mp3
003_Глава вторая.mp3
...
015_Эпилог.mp3
```

### Поддерживаемые форматы имен
- `001.mp3`, `002.mp3` (минимальный формат)
- `1_название.mp3`, `2_название.mp3`
- `01-название.mp3`, `02-название.mp3`
- `001 название.mp3`, `002 название.mp3`

## Названия глав

Программа определяет названия глав в следующем порядке:

1. **ID3 тег TIT2** (Title) - приоритетный источник
2. **Имя файла** (без номера и расширения)
3. **Автоматическое** - "Глава N" как fallback

## Результат работы

### Выходные файлы
```
input_folder/
├── 001.mp3              # Переименованные файлы
├── 002.mp3
├── ...
└── Автор - Название.m4b # Результирующий аудиофайл
```

### Структура M4B файла
- **Формат**: MP4 контейнер с AAC аудио
- **Качество**: 44.1 kHz, 128 kbps
- **Метаданные**: Автор, название, треки
- **Оглавление**: Главы с временными метками
- **Совместимость**: Plex, iTunes, большинство аудиоплееров

## Примеры использования

### Обработка без метаданных
```bash
./audiobook-processor --input "./audiobooks/war_and_peace"
# Результат: audiobook.m4b
```

### Обработка с полными метаданными
```bash
./audiobook-processor \
  --input "./audiobooks/war_and_peace" \
  --author "Лев Толстой" \
  --title "Война и мир"
# Результат: Лев Толстой - Война и мир.m4b
```

### Обработка только с названием
```bash
./audiobook-processor \
  --input "./audiobooks/sherlock" \
  --title "Приключения Шерлока Холмса"
# Результат: Приключения Шерлока Холмса.m4b
```

## Решение проблем

### Ошибка "ffmpeg not found"
```bash
# Проверьте установку FFmpeg
ffmpeg -version

# Добавьте FFmpeg в PATH или установите заново
```

### Ошибка "no MP3 files found"
- Убедитесь, что папка содержит файлы с расширением `.mp3`
- Проверьте правильность пути к папке
- Убедитесь, что у программы есть права на чтение папки

### Ошибка "no number found in filename"
- Файлы должны начинаться с номера (например, `001_name.mp3`)
- Переименуйте файлы вручную или используйте другие инструменты

### Проблемы с кодировкой названий
- Убедитесь, что система поддерживает UTF-8
- Проверьте кодировку ID3 тегов в исходных файлах

## Совместимость

### Протестировано с
- **Операционные системы**: Windows 10/11, macOS 12+, Ubuntu 20.04+
- **Медиасерверы**: Plex Media Server, Jellyfin
- **Плееры**: VLC, iTunes, Apple Books, Google Play Books

### Известные ограничения
- Поддерживает только MP3 входные файлы
- Требует числовой префикс в именах файлов
- Максимальное количество файлов ограничено системными ресурсами

## Разработка

### Структура проекта
```
audiobook-processor/
├── main.go              # Основной исполняемый файл
├── go.mod               # Зависимости Go
├── go.sum               # Контрольные суммы
├── README.md            # Документация
├── CLAUDE.md            # Инструкции для Claude Code
└── task.md              # Техническое задание
```

### Зависимости Go
- `github.com/bogem/id3v2/v2` - Работа с ID3v2 тегами

### Сборка для разных платформ
```bash
# Windows
GOOS=windows GOARCH=amd64 go build -o audiobook-processor.exe main.go

# macOS
GOOS=darwin GOARCH=amd64 go build -o audiobook-processor-macos main.go

# Linux
GOOS=linux GOARCH=amd64 go build -o audiobook-processor-linux main.go
```

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл LICENSE для подробностей.

## Поддержка

Если у вас возникли проблемы или есть предложения по улучшению:

1. Проверьте раздел "Решение проблем" выше
2. Создайте issue в репозитории GitHub
3. Приложите подробное описание проблемы и логи

---

**Примечание**: Программа создана для личного использования и обработки легально приобретенных аудиокниг. Соблюдайте авторские права при использовании.